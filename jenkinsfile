pipeline {
    agent any 
        environment {
            AWS_ACCESS_KEY_ID = credentials ('AWS_ACCESS_KEY_ID')
            AWS_SECRET_ACCESS_KEY = credentials ('AWS_SECRET_ACCESS_KEY')
        }

        stages {
            stage ('Terraform init') {
                steps {
                    sh '''
                terraform init 


                '''
                }
            }

            stage ('Terraform plan') { 
                steps {
                    sh '''
                terraform plan
                '''
                 }
                
            }

            stage ('Terraform apply') {
                steps {
                     sh '''
                terraform apply -auto-approve
                '''
                }
            }

                stage ('Downloading Python') {
                steps{
                    sshagent(credentials : ['SSH_PRIVATE_KEY']) {
                        sh '''
                        ssh -o StrictHostKeyChecking=no ec2-user@35.179.173.93 'sudo yum install python -y && sudo yum install pip -y && pip install ansible'
                        '''
                    }
                }
            }

            stage ('Git cloning ansible-playbook code') {
                steps {
                    sshagent(credentials : ['SSH_PRIVATE_KEY']) {
                        sh'''
                        ssh -o StrictHostKeyChecking=no ec2-user@35.179.173.93 '
                        sudo yum update -y && 
                        sudo yum install git -y && 
                        git clone https://github.com/uthmanakz/playbook-nginx.git'
                        '''
                    }
                }
            }

        

            stage ('Adding inventory in file') {
                steps {
                    sshagent(credentials : ['SSH_PRIVATE_KEY']) {
                       sh '''
                     ssh -o StrictHostKeyChecking=no ec2-user@35.179.173.93 '
                     cd playbook-nginx && 
                     echo "[web-server]" > inventory.ini &&
                     echo "biibbibb" >> inventory.ini &&
                     echo "knonono" >> inventory.ini'
                     '''
                    }
                }
            }

            stage ('Deploying Playbook') {
                steps {
                     withCredentials([sshUserPrivateKey(credentialsId : 'SSH_PRIVATE_KEY' , keyFileVariable: 'PLAYBOOK_KEY')]) {
                            sh '''
                            ssh -o StrictHostKeyChecking=no -i $PLAYBOOK_KEY ec2-user@35.179.173.93 'cd playbook-nginx && touch playbook_key.pem && chmod 600 playbook_key.pem'
                            scp -o StrictHostKeyChecking=no -i $PLAYBOOK_KEY $PLAYBOOK_KEY ec2-user@35.179.173.93:playbook-nginx/playbook_key.pem
                            ssh -o StrictHostKeyChecking=no -i $PLAYBOOK_KEY ec2-user@35.179.173.93 'cd playbook-nginx && ansible-playbook -i inventory.ini --private-key playbook_key.pem ansible.yml --extra-vars '"'"'ansible_ssh_common_args="-o StrictHostKeyChecking=no"'"'"''
                            '''
                        
                    }
                   
                }
            }

             
        }
    
}
