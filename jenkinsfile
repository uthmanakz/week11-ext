pipeline {
    agent any 
        environment {
            AWS_ACCESS_KEY_ID = credentials ('AWS_ACCESS_KEY_ID')
            AWS_SECRET_ACCESS_KEY = credentials ('AWS_SECRET_ACCESS_KEY')
        }

        stages {
            stage ('Terraform init') {
                steps {
                    sh '''
                terraform init 


                '''
                }
            }

            stage ('Terraform plan') { 
                steps {
                    sh '''
                terraform plan
                '''
                 }
                
            }

            stage ('Terraform apply') {
                steps {
                     sh '''
                terraform apply -auto-approve
                '''
                }
            }

            stage ('Moving local directory into ansible machine') {
                steps {
                    sshagent(credentials : ['SSH_PRIVATE_KEY']) {
                        sh'''
                        scp -o StrictHostKeyChecking=no -r ansible-CM ec2-user@18.130.149.14:~

                        '''
                    }
                }
            }

            stage ('Downloading Python') {
                steps{
                    sshagent(credentials : ['SSH_PRIVATE_KEY']) {
                        sh '''
                        ssh -o StrictHostKeyChecking=no ec2-user@18.130.149.14 'sudo yum install python -y && sudo yum install pip -y && pip install ansible'
                        '''
                    }
                }
            }

            stage ('Deploying Playbook') {
                steps {
                     withCredentials([file(credentialsId : 'REMOTE_KEY' , variable: 'PLAYBOOK_KEY')]) {
                            sh '''
                            scp -o StrictHostKeyChecking=no -i $PLAYBOOK_KEY $PLAYBOOK_KEY ec2-user@18.130.149.14:ansible-CM/playbook_key.pem
                            ssh -o StrictHostKeyChecking=no -i $PLAYBOOK_KEY ec2-user@18.130.149.14 'cd ansibnle-CM && chmod 600 playbook_key.pem'
                            ssh -o StrictHostKeyChecking=no -i $PLAYBOOK_KEY ec2-user@18.130.149.14 'cd ansible-CM && ansible-playbook -i inventory.ini --private-key playbook_key.pem  ansible.yml'
                            '''
                        
                    }
                   
                }
            }

             
        }
    
}
