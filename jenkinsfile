pipeline {
    agent any 
        environment {
            AWS_ACCESS_KEY_ID = credentials ('AWS_ACCESS_KEY_ID')
            AWS_SECRET_ACCESS_KEY = credentials ('AWS_SECRET_ACCESS_KEY')
        }

        stages {
            stage ('Terraform init') {
                steps {
                    sh '''
                terraform init
                '''
                }
            }

            stage ('Terraform plan') { 
                steps {
                    sh '''
                terraform plan
                '''
                 }
                
            }

            stage ('Terraform apply') {
                steps {
                     sh '''
                terraform apply -auto-approve
                '''
                }
            }

            stage ('Moving local directory into ansible machine') {
                steps {
                    sshagent(credentials : ['SSH_PRIVATE_KEY']) {
                        sh'''
                        scp -o StrictHostKeyChecking=no -r ansible-CM ec2-user@13.42.56.83:~
                        '''
                    }
                }
            }

            stage ('Installing Nginx then Starting it on web-nodes') {
                steps {
                    sshagent(credentials : ['SSH_PRIVATE_KEY']) {
                        sh '''
                        ssh -o StrictHostKeyChecking=no ec2-user@13.42.56.83 'cd ansible-CM && ansible-playbook -i inventory.ini --private-key uthmanakz.pem ansible.yml'
                        '''
                    }
                }
            }

             
        }
    
}